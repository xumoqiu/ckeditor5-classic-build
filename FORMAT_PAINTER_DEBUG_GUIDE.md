# 格式刷调试和测试指南

## ✅ 已完成更新

格式刷功能已经重新优化，现在使用 `mouseup` 事件而不是 `selection change` 事件，应该能更可靠地工作。

## 🔧 重要修改

1. **事件监听优化**: 从 `selection change` 改为 `mouseup` 事件
2. **格式获取优化**: 优先从 selection 对象获取属性，备用方案从文本节点获取
3. **添加调试日志**: 在关键步骤添加 console.log，方便调试

## 🧪 详细测试步骤

### 步骤 1: 打开测试页面
1. 打开 `sample/index.html` (按 Ctrl+F5 强制刷新，清除缓存)
2. 按 F12 打开浏览器开发者工具
3. 切换到 "Console" (控制台) 标签

### 步骤 2: 准备测试文本
在编辑器中输入以下内容：
```
这是第一段文字
这是第二段文字
```

### 步骤 3: 设置源格式
1. 选中 "第一段文字"
2. 使用工具栏设置格式：
   - 点击 **粗体** 按钮
   - 点击 **字体颜色** 按钮，选择红色
   - 点击 **字体大小** 按钮，选择大字号（如 huge）

现在第一段文字应该是：**粗体 + 红色 + 大字号**

### 步骤 4: 使用格式刷

#### 操作：
1. **选中** 第一段文字（已有格式的文字）
2. **点击** 工具栏中的 **格式刷按钮**（刷子图标）
   - ⚠️ 此时在控制台应该看到：`格式刷：按钮被点击，开始复制格式`
   - ⚠️ 然后看到：`格式刷：已复制格式 [Array]`
   - 格式刷按钮应该变成激活状态（高亮）
3. **选中** 第二段文字（用鼠标拖拽选择）
4. **松开鼠标**
   - ⚠️ 此时在控制台应该看到：`格式刷：正在应用格式到选区`
   - ⚠️ 然后看到：`格式刷：格式已应用`
5. 第二段文字应该自动应用了第一段的格式

### 预期结果：
✅ 第二段文字应该变成：**粗体 + 红色 + 大字号**（与第一段相同）

## 🐛 调试信息说明

在控制台中，您应该看到以下日志：

### 正常流程：
```
1. 格式刷：按钮被点击，开始复制格式
2. 格式刷：已复制格式 [["bold", true], ["fontColor", "rgb(255,0,0)"], ["fontSize", "huge"]]
3. 格式刷：正在应用格式到选区 [["bold", true], ["fontColor", "rgb(255,0,0)"], ["fontSize", "huge"]]
4. 格式刷：格式已应用
```

### 如果出现问题：

#### 问题 1: 没有复制到格式
```
格式刷：已复制格式 []
```
**原因**: 源文本没有格式，或格式类型不在支持列表中
**解决**: 确保源文本真的有格式（粗体、颜色、字号等）

#### 问题 2: 无法应用格式
```
格式刷：无法应用格式 {hasCopiedAttributes: false, isCollapsed: true}
```
**原因**:
- `hasCopiedAttributes: false` - 没有复制到格式
- `isCollapsed: true` - 目标选区是空的（光标状态，没有选中文本）

**解决**: 确保选中目标文本（拖拽选择，而不是只点击）

## 📝 支持的格式类型

格式刷目前支持以下格式：

| 格式 | 工具栏按钮 | 属性名 |
|-----|----------|--------|
| 粗体 | **B** | bold |
| 斜体 | *I* | italic |
| 下划线 | <u>U</u> | underline |
| 代码 | `<>` | code |
| 字体系列 | Font Family | fontFamily |
| 字体大小 | Font Size | fontSize |
| 字体颜色 | A (颜色) | fontColor |
| 背景颜色 | A (背景) | fontBackgroundColor |
| 高亮 | 荧光笔 | highlight |

## 🔄 测试不同组合

### 测试 1: 多重格式
- 源文本：粗体 + 斜体 + 红色
- 预期：目标文本应用所有这些格式

### 测试 2: 单一格式
- 源文本：仅粗体
- 预期：目标文本仅变为粗体，原有其他格式被清除

### 测试 3: 字体和颜色
- 源文本：Arial 字体 + 蓝色 + 大字号
- 预期：目标文本应用这三种格式

## ⌨️ 快捷操作

- **ESC 键**: 取消格式刷（在点击格式刷后，不想应用时）
- **再次点击**: 点击格式刷按钮也可以取消

## ❓ 常见问题

### Q1: 格式刷按钮是灰色的，无法点击
**A**: 必须先选中文本才能激活格式刷按钮

### Q2: 点击格式刷后没有任何反应
**A**:
1. 检查控制台是否有错误信息
2. 确认已经选中了源文本
3. 刷新页面重试（Ctrl+F5）

### Q3: 格式没有正确应用
**A**:
1. 查看控制台日志，确认复制的格式列表
2. 确保目标文本被正确选中（不是空选区）
3. 确认源文本确实有格式

### Q4: 格式刷一直保持激活状态
**A**:
- 按 ESC 键取消
- 或再次点击格式刷按钮

## 📊 浏览器兼容性

测试过的浏览器：
- ✅ Chrome / Edge (推荐)
- ✅ Firefox
- ✅ Safari

## 🔍 如果仍然没有效果

请在控制台中查看：

1. **是否有 JavaScript 错误**（红色文字）
2. **格式刷的日志消息**（应该有上述的 4 条日志）
3. **复制的格式数组是否为空**

如果控制台显示：
```
格式刷：已复制格式 []
```

这说明源文本没有可复制的格式。请确保：
- 源文本真的应用了格式（在编辑器中看起来与普通文本不同）
- 使用的是支持的格式类型（见上表）

## 💡 提示

- 在生产环境中，可以移除 console.log 调试语句
- 如需支持更多格式，可在 `format-painter-command.js` 的 `attributesToCopy` 数组中添加

## 📞 需要帮助？

如果按照以上步骤测试后仍然有问题，请提供：
1. 控制台的完整日志
2. 您的具体操作步骤
3. 预期和实际结果的对比

我会继续帮您调试！

